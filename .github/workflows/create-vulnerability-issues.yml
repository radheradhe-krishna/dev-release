name: Create Vulnerability Issues

on:
  workflow_dispatch:
    inputs:
      jira_issue_key:
        description: "Key of sub-defect created in Jira"
        required: true
      jira_summary:
        description: "Summary of the issue"
        required: false
      label:
        description: "Label to add to issues/PRs"
        required: false
        default: "auto-issue"
      jira_attachments:
        description: 'Attachment URLs'
        required: false
        type: string

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      pull-requests: write
      
    steps:
      - name: Show inputs
        run: |
          echo "Issue Key: ${{ github.event.inputs.jira_issue_key }}"
          echo "Summary: ${{ github.event.inputs.jira_summary }}"
          echo "Attachments: ${{ github.event.inputs.jira_attachments }}"
          echo "== Whoami & token scopes =="
          # show username + scopes header (no token printed)
          curl -sI -H "Authorization: token $GH_PAT_AGENT" https://api.github.com/user | sed -n '1,20p'
          echo
      
          echo "== Repo default branch =="
          curl -s -H "Authorization: token $GH_PAT_AGENT" https://api.github.com/repos/radheradhe-krishna/dev-release | jq -r '.default_branch'
          echo
      
          echo "== Check if attachments branch exists (HTTP code expected: 200 or 404) =="
          curl -s -o /dev/null -w "%{http_code}\n" -H "Authorization: token $GH_PAT_AGENT" "https://api.github.com/repos/radheradhe-krishna/dev-release/git/refs/heads/issue-attachments/SCRUM-31"
          echo
      
          echo "== List attachments dir (debug) =="
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          pwd
          ls -la || true
          ls -la attachments || true
          ls -la "$GITHUB_WORKSPACE" || true
          find . -maxdepth 4 -name "bla.png" -print || true
      - name: Parse attachments
        id: parse_attachments
        run: |
          if [ -n "${{ github.event.inputs.jira_attachments }}" ]; then
            echo "Parsing attachments..."
            IFS=',' read -ra ATTACH_ARRAY <<< "${{ github.event.inputs.jira_attachments }}"
            for ATTACH in "${ATTACH_ARRAY[@]}"; do
              FILENAME=$(echo "$ATTACH" | cut -d':' -f1)
              URL=$(echo "$ATTACH" | cut -d':' -f2-)
              echo "Filename: $FILENAME"
              echo "URL: $URL"
            done
          else
            echo "No attachments provided."
          fi
          
      - name: Download attachments
        run: |
          mkdir -p attachments
          if [ -n "${{ github.event.inputs.jira_attachments }}" ]; then
            IFS=',' read -ra ATTACH_ARRAY <<< "${{ github.event.inputs.jira_attachments }}"
            for ATTACH in "${ATTACH_ARRAY[@]}"; do
              FILENAME=$(echo "$ATTACH" | cut -d':' -f1)
              URL=$(echo "$ATTACH" | cut -d':' -f2-)
              echo "Downloading $FILENAME from $URL"
              curl -L "$URL" -o "attachments/$FILENAME"
            done
          fi

      - name: List downloaded files
        run: ls -la attachments/

      - name: Use image context in code
        run: |
          # You can read the image, encode it, or process it
          # For Copilot, you would describe what you see in the image
          # Example: if the image shows an error, add that to your issue body
          echo "Image downloaded: attachments/bla.png"
          # You could also upload it as an artifact or attach to the GitHub issue
          
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT_AGENT }}" | gh auth login --with-token

      - name: Create GitHub issue from Jira inputs
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ASSIGNEES: ""
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
          JIRA_SUMMARY: ${{ github.event.inputs.jira_summary }}
          JIRA_ATTACHMENTS: ${{ github.event.inputs.jira_attachments }}
          CVSS_SCORE: ${{ github.event.inputs.cvss_score }}
          FINDING_TYPE: ${{ github.event.inputs.finding_type }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          LABEL: ${{ github.event.inputs.label }}
        run: |
          python main.py --from-jira

      - name: Summary
        run: |
          echo "### Vulnerability Issue Created! ðŸŽ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jira Issue:** ${{ github.event.inputs.jira_issue_key }}" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** ${{ github.event.inputs.jira_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Issues tab](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Avulnerability) to see the created vulnerability issue." >> $GITHUB_STEP_SUMMARY

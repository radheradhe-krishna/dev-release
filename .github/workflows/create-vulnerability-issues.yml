name: Create Vulnerability Issues

on:
  workflow_dispatch:
    inputs:
      jira_issue_key:
        description: "Key of sub-defect created in Jira"
        required: true
      jira_summary:
        description: "Summary of the issue"
        required: false
      label:
        description: "Label to add to issues/PRs"
        required: false
        default: "auto-issue"
      jira_attachments:
        description: 'Attachment URLs (format: name:url,name2:url2)'
        required: false
        type: string

jobs:
  create-issues:
    runs-on: ubuntu-latest

    # IMPORTANT: give contents write permission so the workflow (and GH_PAT_AGENT) can create branches and upload files
    permissions:
      issues: write
      contents: write
      pull-requests: write

    # Make GH_PAT_AGENT available to all steps in the job (must be set in repo secrets)
    env:
      GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}

    steps:
      - name: Show inputs
        run: |
          echo "Issue Key: ${{ github.event.inputs.jira_issue_key }}"
          echo "Summary: ${{ github.event.inputs.jira_summary }}"
          echo "Attachments: ${{ github.event.inputs.jira_attachments }}"
          echo "== token scopes (headers) =="
          curl -sI -H "Authorization: token $GH_PAT_AGENT" https://api.github.com/user | sed -n '1,20p'
          echo "== check repo default branch =="
          curl -s -H "Authorization: token $GH_PAT_AGENT" https://api.github.com/repos/radheradhe-krishna/dev-release | jq -r '.default_branch'
          echo "== check attachments branch exists (200 or 404 expected) =="
          curl -s -o /dev/null -w "%{http_code}\n" -H "Authorization: token $GH_PAT_AGENT" "https://api.github.com/repos/radheradhe-krishna/dev-release/git/refs/heads/issue-attachments/${{ github.event.inputs.jira_issue_key }}"
          echo "== list attachments debug =="
          pwd
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la || true
          ls -la attachments || true

      - name: Parse attachments
        id: parse_attachments
        run: |
          if [ -n "${{ github.event.inputs.jira_attachments }}" ]; then
            echo "Parsing attachments..."
            IFS=',' read -ra ATTACH_ARRAY <<< "${{ github.event.inputs.jira_attachments }}"
            for ATTACH in "${ATTACH_ARRAY[@]}"; do
              FILENAME=$(echo "$ATTACH" | cut -d':' -f1)
              URL=$(echo "$ATTACH" | cut -d':' -f2-)
              echo "Filename: $FILENAME"
              echo "URL: $URL"
            done
          else
            echo "No attachments provided."
          fi
          
      - name: Ensure jq is installed (required for discovery)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Discover + download Jira attachments for issue (robust)
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
          JIRA_HOST:  ${{ secrets.JIRA_HOST }}     # e.g. https://jira.mycompany.com (no trailing slash)
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
        run: |
          set -uo pipefail
          mkdir -p attachments

          if [ -z "${JIRA_TOKEN:-}" ]; then
            echo "ERROR: JIRA_TOKEN secret not set"
            exit 1
          fi
          if [ -z "${JIRA_HOST:-}" ]; then
            echo "ERROR: JIRA_HOST secret not set. Set repo secret JIRA_HOST to your Jira base URL (https://jira.example.com)"
            exit 1
          fi
          if [ -z "${JIRA_ISSUE_KEY:-}" ]; then
            echo "No issue key provided; skipping discovery."
            exit 0
          fi

          echo "Using JIRA_HOST=$JIRA_HOST"
          echo "Querying attachments for issue $JIRA_ISSUE_KEY"

          # Request the issue attachments field
          API_URL="$JIRA_HOST/rest/api/2/issue/$JIRA_ISSUE_KEY?fields=attachment"
          echo "Calling: $API_URL"
          # Capture response and HTTP status for helpful debugging
          RESP_FILE="$(mktemp)"
          HTTP_CODE=$(curl -sS -w "%{http_code}" -H "Authorization: Bearer $JIRA_TOKEN" -o "$RESP_FILE" "$API_URL") || CURL_E=$?

          # If curl failed at network/DNS level (no HTTP_CODE) print info
          if [ -z "${HTTP_CODE:-}" ] || [ "${HTTP_CODE}" -lt 100 ]; then
            echo "curl failed (likely network/DNS). exit: ${CURL_E:-unknown}"
            echo "Detailed curl output (first 800 chars):"
            head -c 800 "$RESP_FILE" || true
            rm -f "$RESP_FILE"
            exit 1
          fi

          echo "HTTP status: $HTTP_CODE"
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to fetch attachments JSON (HTTP $HTTP_CODE). Response (first 2000 chars):"
            head -c 2000 "$RESP_FILE" || true
            rm -f "$RESP_FILE"
            exit 1
          fi

          # parse attachments and download them
          ATT_JSON="$(cat "$RESP_FILE")"
          rm -f "$RESP_FILE"
          echo "$ATT_JSON" | jq -r '.fields.attachment[]? | "\(.filename) \(.content)"' | while read -r filename url; do
            if [ -z "$filename" ] || [ -z "$url" ]; then
              echo "No attachments found or parsing issue"
              continue
            fi
            echo "Downloading attachment: $filename"
            # Download with bearer auth; follow redirects
            if curl -sS -L -H "Authorization: Bearer $JIRA_TOKEN" --fail -o "attachments/$filename" "$url"; then
              echo "Saved attachments/$filename"
            else
              echo "Failed to download $url (check token / permissions / URL)."
              rm -f "attachments/$filename" || true
            fi
          done

          echo "Downloaded files:"
          ls -la attachments || true

      - name: List downloaded files
        run: ls -la attachments/ || true

      - name: Use image context in code
        run: |
          echo "Image downloaded: attachments/*"
          find attachments -type f -maxdepth 3 -print || true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure attachments branch exists (fallback)
        # create the attachments branch from default branch if files exist and branch missing
        run: |
          set -euo pipefail
          BRANCH="issue-attachments/${{ github.event.inputs.jira_issue_key }}"
          REPO="${{ github.repository }}"
          # only run if attachments dir contains files
          if [ -z "$(ls -A attachments 2>/dev/null || true)" ]; then
            echo "No local attachments found; skipping branch creation."
            exit 0
          fi
          echo "Attachments found â€” ensuring branch $BRANCH exists"
          DEFAULT=$(curl -s -H "Authorization: token $GH_PAT_AGENT" "https://api.github.com/repos/$REPO" | jq -r .default_branch)
          BASE_SHA=$(curl -s -H "Authorization: token $GH_PAT_AGENT" "https://api.github.com/repos/$REPO/git/refs/heads/$DEFAULT" | jq -r .object.sha)
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GH_PAT_AGENT" "https://api.github.com/repos/$REPO/git/refs/heads/$BRANCH")
          if [ "$CODE" = "404" ]; then
            echo "Creating branch $BRANCH from $DEFAULT ($BASE_SHA)"
            curl -s -X POST -H "Authorization: token $GH_PAT_AGENT" -H "Content-Type: application/json" \
              "https://api.github.com/repos/$REPO/git/refs" \
              -d "{\"ref\":\"refs/heads/$BRANCH\",\"sha\":\"$BASE_SHA\"}" | jq .
          else
            echo "Branch $BRANCH exists (HTTP $CODE)"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT_AGENT }}" | gh auth login --with-token

      - name: Create GitHub issue from Jira inputs
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ASSIGNEES: ""
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
          JIRA_SUMMARY: ${{ github.event.inputs.jira_summary }}
          JIRA_ATTACHMENTS: ${{ github.event.inputs.jira_attachments }}
          CVSS_SCORE: ${{ github.event.inputs.cvss_score }}
          FINDING_TYPE: ${{ github.event.inputs.finding_type }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          LABEL: ${{ github.event.inputs.label }}
        run: |
          python main.py --from-jira

      - name: Summary
        run: |
          echo "### Vulnerability Issue Created! ðŸŽ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jira Issue:** ${{ github.event.inputs.jira_issue_key }}" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** ${{ github.event.inputs.jira_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Issues tab](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Avulnerability) to see the created vulnerability issue." >> $GITHUB_STEP_SUMMARY

name: Create Vulnerability Issues

on:
  workflow_dispatch:
    inputs:
      jira_issue_key:
        description: "Key of sub-defect created in Jira"
        required: true
      jira_summary:
        description: "Summary of the issue"
        required: false
      jira_label:
        description: "Label to add for issues/PRs"
        required: false
        default: "auto-issue"
      jira_attachments:
        description: 'Attachment URLs (format: name:url,name2:url2)'
        required: false
        type: string
      jira_description:
        description: 'description details'
        required: false
        type: string

jobs:
  create-issues:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    # Make GH_PAT_AGENT available to all steps in the job (must be set in repo secrets)
    env:
      GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}

    steps:
      - name: Show inputs
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
        run: |
          echo "Issue Key: ${{ github.event.inputs.jira_issue_key }}"
          echo "Summary: ${{ github.event.inputs.jira_summary }}"
          echo "Attachments (manual list): ${{ github.event.inputs.jira_attachments }}"
          echo "Description: ${{ github.event.inputs.jira_description }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    
      - name: Ensure jq is installed (required for discovery & payload building)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
    
      - name: Show inputs (safe debug)
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
        run: |
          echo "Issue Key: ${{ github.event.inputs.jira_issue_key }}"
          echo "Summary: ${{ github.event.inputs.jira_summary }}"
          echo "Attachments (manual list): ${{ github.event.inputs.jira_attachments }}"
          echo "Description: ${{ github.event.inputs.jira_description }}"
          echo "== token scopes (headers) =="
          curl -sI -H "Authorization: token $GH_PAT_AGENT" https://api.github.com/user | sed -n '1,20p'
          echo "== check repo default branch =="
          curl -s -H "Authorization: token $GH_PAT_AGENT" https://api.github.com/repos/${{ github.repository }} | jq -r '.default_branch'
          echo "== list attachments debug =="
          pwd
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la || true
          ls -la attachments || true
    
      - name: Parse attachments (input list)
        id: parse_attachments
        run: |
          if [ -n "${{ github.event.inputs.jira_attachments }}" ]; then
            echo "Parsing attachments..."
            IFS=',' read -ra ATTACH_ARRAY <<< "${{ github.event.inputs.jira_attachments }}"
            for ATTACH in "${ATTACH_ARRAY[@]}"; do
              FILENAME=$(echo "$ATTACH" | cut -d':' -f1)
              URL=$(echo "$ATTACH" | cut -d':' -f2-)
              echo "Filename: $FILENAME"
              echo "URL: $URL"
            done
          else
            echo "No attachments provided."
          fi
    
      - name: Discover + download Jira attachments (use Basic auth)
        if: ${{ secrets.JIRA_HOST != '' && secrets.JIRA_USERNAME != '' && secrets.JIRA_API_TOKEN != '' && github.event.inputs.jira_issue_key != '' }}
        env:
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
        run: |
          set -euo pipefail
          mkdir -p attachments
    
          if [ -z "${JIRA_HOST:-}" ]; then echo "JIRA_HOST not set"; exit 1; fi
          if [ -z "${JIRA_ISSUE_KEY:-}" ]; then echo "No issue key provided; skipping"; exit 0; fi
    
          API_URL="${JIRA_HOST}/rest/api/3/issue/${JIRA_ISSUE_KEY}?fields=attachment"
          echo "Calling: $API_URL"
    
          RESP_FILE="$(mktemp)"
          HTTP_CODE=$(curl -sS -w "%{http_code}" -u "${JIRA_USERNAME}:${JIRA_API_TOKEN}" -o "$RESP_FILE" "$API_URL") || CURL_E=$?
    
          if [ -z "${HTTP_CODE:-}" ] || [ "${HTTP_CODE}" -lt 100 ]; then
            echo "curl network/DNS error. exit ${CURL_E:-unknown}"
            head -c 800 "$RESP_FILE" || true; rm -f "$RESP_FILE"; exit 1
          fi
    
          echo "HTTP status: $HTTP_CODE"
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Failed to fetch attachments JSON (HTTP $HTTP_CODE). Response snippet:"
            head -c 2000 "$RESP_FILE" || true
            rm -f "$RESP_FILE"
            exit 1
          fi
    
          # Safer extraction: base64 each attachment object to avoid splitting issues
          jq -c '.fields.attachment[]?' "$RESP_FILE" | while read -r item; do
            filename=$(echo "$item" | jq -r '.filename')
            url=$(echo "$item" | jq -r '.content')
            safe=$(basename "${filename// /_}" | sed 's/[^A-Za-z0-9._-]//g')
            echo "Downloading $filename -> attachments/$safe from $url"
            if curl -sS -L -u "${JIRA_USERNAME}:${JIRA_API_TOKEN}" --fail -o "attachments/$safe" "$url"; then
              echo "Saved attachments/$safe"
            else
              echo "Failed to download $url"
              rm -f "attachments/$safe" || true
            fi
          done
    
          rm -f "$RESP_FILE" || true
          echo "Downloaded files:"; ls -la attachments || true
    
      - name: Download attachments from input list (fallback)
        if: ${{ github.event.inputs.jira_attachments != '' && (secrets.JIRA_HOST == '' || secrets.JIRA_USERNAME == '' || secrets.JIRA_API_TOKEN == '') }}
        run: |
          set -euo pipefail
          mkdir -p attachments
          IFS=',' read -ra ATTACH_ARRAY <<< "${{ github.event.inputs.jira_attachments }}"
          for ATTACH in "${ATTACH_ARRAY[@]}"; do
            FILENAME=$(echo "$ATTACH" | cut -d':' -f1)
            URL=$(echo "$ATTACH" | cut -d':' -f2-)
            if [ -z "$FILENAME" ] || [ -z "$URL" ]; then
              echo "Skipping invalid attachment entry: $ATTACH"
              continue
            fi
            SAFE="$(basename "${FILENAME// /_}" | sed 's/[^A-Za-z0-9._-]//g')"
            echo "Downloading $URL -> attachments/$SAFE"
            if curl -sS -L --fail -o "attachments/$SAFE" "$URL"; then
              echo "Saved attachments/$SAFE"
            else
              echo "Failed to download $URL (skipped)"
              rm -f "attachments/$SAFE" || true
            fi
          done
          ls -la attachments || true
    
      - name: List downloaded files (debug)
        run: ls -la attachments/ || true
    
      - name: Ensure attachments branch exists (via GitHub API)
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ATTACHMENTS_BRANCH: attachments
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          BRANCH="${ATTACHMENTS_BRANCH}"
          API="https://api.github.com/repos/${REPO}"
    
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${GH_PAT_AGENT}" "${API}/git/refs/heads/${BRANCH}" || true)
    
          if [ "${CODE}" = "200" ]; then
            echo "Branch ${BRANCH} already exists"
            exit 0
          fi
    
          if [ "${CODE}" != "404" ]; then
            echo "Unexpected HTTP ${CODE} when checking branch; aborting"
            exit 1
          fi
    
          DEFAULT=$(curl -s -H "Authorization: token ${GH_PAT_AGENT}" "${API}" | jq -r .default_branch)
          BASE_SHA=$(curl -s -H "Authorization: token ${GH_PAT_AGENT}" "${API}/git/refs/heads/${DEFAULT}" | jq -r .object.sha)
    
          echo "Creating branch ${BRANCH} from ${DEFAULT} (${BASE_SHA})"
          curl -s -X POST -H "Authorization: token ${GH_PAT_AGENT}" -H "Content-Type: application/json" \
            "${API}/git/refs" \
            -d "{\"ref\":\"refs/heads/${BRANCH}\",\"sha\":\"${BASE_SHA}\"}" | jq .
    
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
    
      - name: Install dependencies (uploader)
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests
    
      - name: Upload attachments to attachments branch (write uploaded_urls.txt)
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
          ATTACHMENTS_DIR: attachments
          ATTACHMENTS_BRANCH: attachments
        run: |
          python scripts/upload_attachments_to_branch_and_write_urls.py
          echo "Uploaded URLs written to uploaded_urls.txt"
          ls -la uploaded_urls.txt || true
    
      - name: Create GitHub issue from Jira inputs
        id: create_issue
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ASSIGNEES: "copilot-swe-agent"
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
          JIRA_SUMMARY: ${{ github.event.inputs.jira_summary }}
          JIRA_ATTACHMENTS: ${{ github.event.inputs.jira_attachments }}
          JIRA_DESCRIPTION: ${{ github.event.inputs.jira_description }}
          CVSS_SCORE: ${{ github.event.inputs.cvss_score }}
          FINDING_TYPE: ${{ github.event.inputs.finding_type }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          LABEL: ${{ github.event.inputs.label }}
        run: |
          # Ensure main.py creates the GitHub issue and writes the created issue number to issue_number.txt
          python main.py --from-jira
          if [ -f issue_number.txt ]; then
            ISSUE_NUMBER=$(cat issue_number.txt)
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi
    
      - name: Post comment with uploaded images
        if: ${{ steps.create_issue.outputs.issue_number != '' }}
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ steps.create_issue.outputs.issue_number }}
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/${GITHUB_REPOSITORY}"
          if [ ! -f uploaded_urls.txt ]; then
            echo "uploaded_urls.txt not found; nothing to post"
            exit 0
          fi
          BODY="Uploaded Jira attachments for ${JIRA_ISSUE_KEY}:\n\n"
          while IFS= read -r url; do
            fname=$(basename "$url")
            BODY="${BODY}![${fname}](${url})\n\n"
          done < uploaded_urls.txt
    
          echo "Posting comment to issue #${ISSUE_NUMBER}"
          payload=$(jq -n --arg b "$BODY" '{body:$b}')
          resp=$(curl -s -H "Authorization: token ${GH_PAT_AGENT}" -H "Content-Type: application/json" -X POST -d "$payload" "${API}/issues/${ISSUE_NUMBER}/comments")
          if echo "$resp" | jq -e '.id' >/dev/null 2>&1; then
            echo "Comment posted successfully: $(echo "$resp" | jq -r .html_url)"
          else
            echo "Failed to post comment. Response:"
            echo "$resp" | sed -n '1,200p'
            exit 1
          fi
    
      - name: Summary
        run: |
          echo "### Vulnerability Issue Created! ðŸŽ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jira Issue:** ${{ github.event.inputs.jira_issue_key }}" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** ${{ github.event.inputs.jira_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Issues tab](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Avulnerability) to see the created vulnerability issue." >> $GITHUB_STEP_SUMMARY

name: Create Vulnerability Issues

on:
  workflow_dispatch:
    inputs:
      jira_issue_key:
        description: "Key of sub-defect created in Jira"
        required: true
      jira_summary:
        description: "Summary of the issue"
        required: false
      jira_label:
        description: "Label to add for issues/PRs"
        required: false
        default: "auto-issue"
      jira_attachments:
        description: 'Attachment URLs (format: name:url,name2:url2)'
        required: false
        type: string
      jira_description:
        description: 'description details'
        required: false
        type: string

jobs:
  create-issues:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    # Make GH_PAT_AGENT available to all steps in the job (must be set in repo secrets)
    env:
      GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}

    steps:
      - name: Show inputs
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
        run: |
          echo "Issue Key: ${{ github.event.inputs.jira_issue_key }}"
          echo "Summary: ${{ github.event.inputs.jira_summary }}"
          echo "Attachments (manual list): ${{ github.event.inputs.jira_attachments }}"
          echo "Description: ${{ github.event.inputs.jira_description }}"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq is installed (required for discovery)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GH_PAT_AGENT }}" | gh auth login --with-token

      - name: Create GitHub issue from Jira inputs
        env:
          GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ASSIGNEES: "copilot-swe-agent"
          JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
          JIRA_SUMMARY: ${{ github.event.inputs.jira_summary }}
          JIRA_ATTACHMENTS: ${{ github.event.inputs.jira_attachments }}
          JIRA_DESCRIPTION: ${{ github.event.inputs.jira_description }}
          CVSS_SCORE: ${{ github.event.inputs.cvss_score }}
          FINDING_TYPE: ${{ github.event.inputs.finding_type }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          LABEL: ${{ github.event.inputs.label }}
        run: |
          python main.py --from-jira

      # - name: Upload attachments to attachments branch and post comment (Python)
      #   env:
      #     GITHUB_REPOSITORY: ${{ github.repository }}
      #     GH_PAT_AGENT: ${{ secrets.GH_PAT_AGENT }}
      #     JIRA_ISSUE_KEY: ${{ github.event.inputs.jira_issue_key }}
      #     ISSUE_NUMBER: ${{ steps.read_issue.outputs.issue_number }}
      #     ATTACHMENTS_DIR: attachments
      #     ATTACHMENTS_BRANCH: attachments
      #   run: |
      #     python scripts/upload_attachments_to_branch_and_comment.py
          
      - name: Summary
        run: |
          echo "### Vulnerability Issue Created! ðŸŽ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jira Issue:** ${{ github.event.inputs.jira_issue_key }}" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** ${{ github.event.inputs.jira_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [Issues tab](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+is%3Aopen+label%3Avulnerability) to see the created vulnerability issue." >> $GITHUB_STEP_SUMMARY
